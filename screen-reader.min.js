/** ScreenReader JS Min */
class ScreenReader{constructor(){this._debug=!1,this._notyf=null,this._synth=window.speechSynthesis,this._synth.cancel(),this._audioSettings=new AudioSettings,this._voices=[],this._readerStatus="false",this.isLocalStorageAvailable()&&(this._readerStatus=localStorage.getItem("toggleScreenReader")||"false",this._readerStatus=/^true$/i.test(this._readerStatus)),this._hoverDelayReading=1e3,this._localVoiceName="",this._textReplacements={},this._appStrings={noSlovenianVoice:"Ni slovenskega glasu.",readingStopped:"Branje besedila je prekinjeno.",readAll:"Prebrano bo celotno besedilo.<br>CTRL - prekinitev branja",readingEnabled:"Branje besedila je vključeno.",readingDisabled:"Branje besedila je izključeno.",readerStartFailed:"Branja ni mogoče začeti.",readerBtnTitle:"Branje besedila&#013;Bljižnica: CTRL+B",readerDenied:"Branje besedila je samodejno onemogočeno.",synthTitle:"Sinteza govora:",interrupted:"branje predčasno prekinjeno","not-allowed":"branje ni dovoljeno",voice:"Glas: ",readerName:"Govornik TTS",keysEnabled:"Bljižnice so vklopljene<br><br>ALT+N - vklop/izklop bralca<br>ALT+B - preberi vse<br>CTRL - prekinitev branja",keysDisabled:"Bljižnice so izklopljene"},this._lastElement=null,this._hoverTimeout=null,this._enableMouse=!0,this.initialize()}isLocalStorageAvailable(){var e="testKey-"+Date.now();try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}simulateKeyPress(){var e=document.createEvent("KeyboardEvent");e[void 0!==e.initKeyboardEvent?"initKeyboardEvent":"initKeyEvent"]("keydown",!0,!0,window,!1,!1,!1,!1,40,0),document.dispatchEvent(e)}selectSlovenianVoice(e){let t=null;for(let s=0;s<e.length;s++)if("sl-SI"===e[s].lang||e[s].lang.startsWith("sl")){if(e[s].name.includes("Lado")||e[s].name.includes("Hugo"))return e[s];t||(t=e[s]),this._debug&&console.log(e[s].name)}return t}replaceText(e){return this._textReplacements[e]||e}translateText(e){return this._appStrings[e]||e}getAllTextFromElement(e){if(!e)return[];let t=[],s="";return e.childNodes.forEach((a=>{a.nodeType===Node.TEXT_NODE||a.nodeType===Node.ELEMENT_NODE&&["SPAN","B","I","U"].includes(a.tagName)?s+=a.textContent.trim():a.nodeType===Node.ELEMENT_NODE&&(s&&(t.push([s,e]),s=""),t.push(...this.getAllTextFromElement(a)))})),s&&t.push([s,e]),t}speakTexts(e){screenReader._enableMouse=!1;let t=0;!function s(){if(t<e.length){if(screenReader._enableMouse)return void screenReader.speakMsg("");screenReader.speakMsg(e[t][0],e[t][1]),t++;const a=setInterval((()=>{screenReader._synth.speaking||(clearInterval(a),s())}),100)}else screenReader._enableMouse=!0}()}speakMsg(e,t=null){if(this._readerStatus){this._synth.cancel(),this._debug&&console.log(`Berem: ${e}`);var s=new SpeechSynthesisUtterance;let r=this.selectSlovenianVoice(this._voices);if(this._debug&&console.log(r.name),!r)return void this.playTTSExternal(e,t);var a;s.voice=r,s.text=e,s.volume=this._audioSettings.volume,s.rate=this._audioSettings.rate,s.pitch=this._audioSettings.pitch,s.onstart=e=>{if(t){var s=window.getComputedStyle(t).color;this._debug&&console.log("Barva:"+s),t.style.color="rgb(255, 255, 255)"===s||"rgba(255, 255, 255, 1)"===s||"white"===s?"yellow":"red"}a=e.timeStamp,this._debug&&console.log("Start:"+a)},s.onend=e=>{t&&(t.style.color=""),a=e.timeStamp-a,this._debug&&console.log("End:"+e.timeStamp),this._debug&&console.log("Diff:"+a/1e3+" s"),isNaN(a)&&this._notyf.error(this._appStrings.readerStartFailed)},s.onerror=e=>{"interrupted"===e.error||this._notyf.error(`${this._appStrings.synthTitle}<br>${this.translateText(e.error)}`),this._debug&&console.log(`Sinteza govora: ${e.error}`),t&&(t.style.color="")},this._synth.speak(s),this._debug&&console.log(this._synth)}}PopulateVoices(){this._voices=this._synth.getVoices()}injectButton(){var e=document.createElement("li"),t=document.createElement("a");t.href="#",t.title=this._appStrings.readerBtnTitle,t.id="readerBtn";var s=document.createElement("span");s.id="readerIcon",this._readerStatus?s.className="fa fa-volume-up":s.className="fa fa-volume-off",t.appendChild(s),e.appendChild(t),document.querySelector("#navbar .navbar-nav").appendChild(e),t.onclick=()=>{this._synth.speak(new SpeechSynthesisUtterance(""));const e=this._synth.speaking||this._synth.pending;this._debug&&console.log("Available:"+e),this._notyf.dismissAll(),this.speakMsg("");var t="false";this.isLocalStorageAvailable()&&(t=localStorage.getItem("toggleScreenReader"));var a=!("true"===t);this.isLocalStorageAvailable()&&localStorage.setItem("toggleScreenReader",a.toString()),this._debug&&console.log("Reader:",a),this._readerStatus=a,this._readerStatus=/^true$/i.test(this._readerStatus),this._readerStatus?this._notyf.success(this._appStrings.readingEnabled+"<br><br>"+this._appStrings.voice+"<br>"+this._localVoiceName):this._notyf.success(this._appStrings.readingDisabled),this._readerStatus?s.className="fa fa-volume-up":s.className="fa fa-volume-off"}}playTTSExternal(e,t){var s=document.getElementById("audio-player");s&&(s.pause(),s.remove());var a=new XMLHttpRequest;a.open("POST","https://s1.govornik.eu/",!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var r="voice=lili&text="+encodeURIComponent(e)+"&source=SpletniUcbenik&version=2&format=mp3";a.responseType="blob",a.onload=function(){if(200===a.status){var e=a.response,s=URL.createObjectURL(e),r=document.createElement("audio");r.id="audio-player",r.style.display="none",r.autoplay=!0,r.src=s,r.addEventListener("play",(function(){if(t){var e=window.getComputedStyle(t).color;this._debug&&console.log("Barva:"+e),t.style.color="rgb(255, 255, 255)"===e||"rgba(255, 255, 255, 1)"===e||"white"===e?"yellow":"red"}})),r.addEventListener("ended",(function(){t&&(t.style.color="")})),r.addEventListener("abort",(function(){t.style.color=""})),r.addEventListener("pause",(function(){r.ended||(t.style.color="")})),document.body.appendChild(r),r.play().catch((e=>{console.log("Predajanje onemogočeno.")}))}else console.log("Napaka predvajanja: ",a.status),console.info(this._appStrings.noSlovenianVoice),this._notyf.error(this._appStrings.noSlovenianVoice)},a.onerror=function(){console.log("Napaka zahteve.")},a.send(r)}enableNotyf(){var e=document.createElement("link");e.rel="stylesheet",e.href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css",document.head.appendChild(e);var t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js",document.body.appendChild(t),setTimeout((()=>{this._notyf=new Notyf({duration:3500}),this.checkReader(),this._localVoiceName="";let e=screenReader.selectSlovenianVoice(screenReader._voices);this._localVoiceName=e?e.name:this._appStrings.readerName;let t=!1,s=!1,a=!1,r=!1,n=!1;screenReader.isLocalStorageAvailable()&&(n=localStorage.getItem("ScreenReaderToggleKeyboard")||"false",n=/^true$/i.test(n)),document.body.addEventListener("keydown",(function(e){if(e.ctrlKey&&!t&&n&&(t=!0,screenReader.speakMsg(""),screenReader._enableMouse=!0,screenReader.status&&(screenReader._notyf.dismissAll(),screenReader._notyf.success(screenReader._appStrings.readingStopped))),e.altKey&&"b"===e.key.toLowerCase()&&!r&&n){r=!0,screenReader._enableMouse=!1;let e=screenReader.getAllTextFromElement(document.querySelector("#page-content-wrapper")),t=e.findIndex((e=>e[0].includes("«")));-1!==t&&e.splice(t,e.length-t),screenReader._readerStatus?screenReader._notyf.success(screenReader._appStrings.readAll):screenReader._notyf.error(screenReader._appStrings.readingDisabled),screenReader.speakTexts(e)}e.altKey&&"n"===e.key.toLowerCase()&&!a&&n&&(a=!0,document.getElementById("readerIcon").click()),e.ctrlKey&&"b"===e.key.toLowerCase()&&!s&&(s=!0,n=!n,screenReader.isLocalStorageAvailable()&&localStorage.setItem("ScreenReaderToggleKeyboard",n),screenReader._notyf.dismissAll(),n?screenReader._notyf.success({message:screenReader._appStrings.keysEnabled,duration:2e4,dismissible:!0}):screenReader._notyf.success(screenReader._appStrings.keysDisabled))})),document.body.addEventListener("keyup",(function(e){!1!==e.altKey&&"n"!==e.key.toLowerCase()||(a=!1),!1!==e.altKey&&"b"!==e.key.toLowerCase()||(r=!1),!1!==e.ctrlKey&&"b"!==e.key.toLowerCase()||(s=!1),!1===e.ctrlKey&&(t=!1)}))}),500)}checkReader(){this._synth.speak(new SpeechSynthesisUtterance(""));const e=this._synth.speaking||this._synth.pending;e||localStorage.setItem("ScreenReaderToggleKeyboard","false"),this._debug&&console.log("Reader:",this._readerStatus),this._readerStatus&&(e||(document.getElementById("readerIcon").className="fa fa-volume-off",this._notyf.error(this._appStrings.readerDenied),this.isLocalStorageAvailable()&&(localStorage.setItem("toggleScreenReader","false"),localStorage.setItem("ScreenReaderToggleKeyboard","false")),this._readerStatus=!1))}get status(){return this._readerStatus}set hoverDelay(e){if(!(e>=100&&e<=5e3))throw new Error("Hover delay must be between 100ms and 5000ms.");this._hoverDelayReading=e}set audioSettings(e){if(!e)throw new Error("AudioSettings error.");this._audioSettings=e}set debug(e){if("boolean"!=typeof e)throw new Error("Not a boolean error.");this._debug=e}set textReplacements(e){if(!e)throw new Error("textReplacements error.");this._textReplacements=e}get textReplacements(){return this._textReplacements}get hoverDelay(){return this._hoverDelayReading}get audioSettings(){return this._audioSettings}handleHoverOrTouch(e){let t,s;if("mousemove"===e.type)t=e.clientX,s=e.clientY;else if("touchstart"===e.type||"touchmove"===e.type){const a=e.touches[0];t=a.clientX,s=a.clientY}var a=document.elementFromPoint(t,s);if(a!==this._lastElement)if(this._hoverTimeout&&clearTimeout(this._hoverTimeout),this._lastElement=a,this._enableMouse&&a&&a!==document.documentElement&&a!==document.body){let e="";a.innerText.trim()&&(e=a.innerText.trim()),"IMG"===a.tagName?e=a.alt||"Slika":"INPUT"===a.tagName?e=a.placeholder||a.title||"":"A"===a.tagName&&a.title&&(e=a.title),e=this.replaceText(e),"DIV"!==a.tagName&&"UL"!==a.tagName&&"CENTER"!==a.tagName&&"TABLE"!==a.tagName&&(this._hoverTimeout=setTimeout((()=>{e&&this.speakMsg(e,a)}),this._hoverDelayReading))}else this._lastElement=null}initialize(){this.injectButton(),this.enableNotyf(),this.PopulateVoices(),this.simulateKeyPress(),void 0!==this._synth&&(this._synth.onvoiceschanged=()=>this.PopulateVoices()),document.addEventListener("mousemove",this.handleHoverOrTouch.bind(this),{passive:!0}),document.addEventListener("touchstart",this.handleHoverOrTouch.bind(this),{passive:!0}),document.addEventListener("touchmove",this.handleHoverOrTouch.bind(this),{passive:!0})}}class AudioSettings{constructor(){this._volume=1,this._pitch=1,this._rate=1}get volume(){return this._volume}set volume(e){if(!(e>=0&&e<=1))throw new Error("Volume must be between 0 and 1.");this._volume=e}get pitch(){return this._pitch}set pitch(e){if(!(e>=.5&&e<=2))throw new Error("Pitch must be between 0.5 and 2.");this._pitch=e}get rate(){return this._rate}set rate(e){if(!(e>=.5&&e<=2))throw new Error("Rate must be between 0.5 and 2.");this._rate=e}}const settings=new AudioSettings,screenReader=new ScreenReader;settings.volume=.5;const textReplacements={"«":"Prejšnje poglavje","»":"Naslednje poglavje","‹":"Nazaj","›":"Naprej","×":"Zapri"};ScreenReader.audioSettings=settings,screenReader.hoverDelay=500;let localVoiceAvailable=screenReader.selectSlovenianVoice(screenReader._voices);screenReader.hoverDelay=500,screenReader.textReplacements=textReplacements,screenReader.debug=!1;
